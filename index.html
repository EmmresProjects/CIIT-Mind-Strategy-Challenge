<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CIIT Mind & Strategy Challenge — Game Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#00364d;
    --card:#0f2630;
    --muted:#9fb6c2;
    --text:#eef7fb;
    --accent-1:#6C8EF5;
    --accent-2:#7BDF7B;
    --accent-3:#FFD36E;
    --accent-4:#FF8A8A;
    --glass: rgba(255,255,255,0.03);
    --shadow: 0 6px 18px rgba(0,0,0,0.45);
    --radius:10px;
    --mono: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:var(--mono); background:var(--bg); color:var(--text);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color: transparent;
  }

  .wrap{max-width:1200px;margin:18px auto;padding:14px;display:grid;grid-template-columns:1fr;gap:12px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border-radius:10px;box-shadow:var(--shadow)}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px}
  h1{margin:0;font-size:16px;color:var(--text)}
  p.lead{margin:0;color:var(--muted);font-size:12px}

  .top-cta{margin-left:auto;display:flex;align-items:center;gap:10px}
  .rounds-summary{color:var(--muted);font-weight:700;font-size:13px;display:flex;gap:10px;align-items:center}
  .finish-cta{display:flex;gap:8px;align-items:center}
  .finish-btn{background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:white;border:none;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.45)}
  .finish-btn[disabled]{opacity:0.45;cursor:default;box-shadow:none}

  main{background:var(--card);border-radius:10px;padding:12px;box-shadow:var(--shadow)}
  .card{background:transparent;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.03)}
  .card h3{margin:0;font-size:13px;color:var(--text)}
  .card p{margin:6px 0 0;color:var(--muted);font-size:12px}

  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:var(--accent-1);color:white;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--accent-1);border:1px dashed rgba(108,142,245,0.06)}
  .btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
  .mode{padding:6px 8px;border-radius:8px;background:#0b3b48;border:1px solid rgba(255,255,255,0.02);font-weight:600;color:var(--muted);cursor:pointer}

  /* Game area compact */
  #play-area{margin-top:10px;display:flex;gap:10px;flex-direction:column}
  .game-panel{display:none;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:8px;padding:10px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
  .game-panel.active{display:block}
  .game-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .game-title{display:flex;gap:8px;align-items:center}
  .game-title .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
  .dot.t1{background:var(--accent-1)} .dot.t2{background:var(--accent-2)} .dot.t3{background:var(--accent-3)} .dot.t4{background:var(--accent-4)}
  .game-body{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}

  /* TicTacToe */
  .t3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:260px;height:260px}
  .cell{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-size:40px;border-radius:8px;cursor:pointer;user-select:none;border:1px solid rgba(255,255,255,0.03);color:var(--text)}
  .tinfo{font-size:12px;color:var(--muted)}

  /* Simon */
  .simon-grid{display:grid;grid-template-columns:repeat(2,110px);gap:8px}
  .pad{width:110px;height:110px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;color:#08222b;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,0.35)}
  .pad.red{background:linear-gradient(180deg,#ff6b6b,#ff3b3b)} .pad.green{background:linear-gradient(180deg,#2ecc71,#1aa34a)} .pad.blue{background:linear-gradient(180deg,#4da6ff,#1f6dff)} .pad.yellow{background:linear-gradient(180deg,#ffd36e,#ffbf2e)}

  /* Battleship compact */
  .board-wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .board{display:grid;grid-template-columns:repeat(10,22px);gap:4px;padding:6px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .cell-b{width:22px;height:22px;background:transparent;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .cell-b.miss{background:#9fd3ff;color:#01263f}     /* blue bullet */
  .cell-b.bullet{background:#9fd3ff;color:#01263f}
  .cell-b.hit{background:#ff5a5a;color:white}
  .cell-b.sunk{background:#0b0b0b;color:#fff}
  .ship-vis{background:linear-gradient(135deg,#6fe6a6,#38c572);border-radius:3px;height:100%;width:100%}
  .status-line{font-size:12px;color:var(--muted)}

  /* UNO compact 2-row hand */
  .uno-area{display:flex;gap:12px;align-items:flex-start}
  .hand{display:flex;gap:6px;flex-wrap:wrap;max-height:220px;overflow:auto;padding:6px}
  .hand.two-rows{height:116px} /* approx 2 rows depending on card size */
  .card-ui{width:56px;height:80px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:16px;box-shadow:0 8px 16px rgba(0,0,0,0.45);cursor:pointer}
  .uno-red{background:linear-gradient(180deg,#ff4b4b,#c92b2b)} .uno-green{background:linear-gradient(180deg,#2ecc71,#198c4a)} .uno-blue{background:linear-gradient(180deg,#4da6ff,#1f6dff)} .uno-yellow{background:linear-gradient(180deg,#ffd36e,#ffbf2e)}
  .uno-deck{width:56px;height:80px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700;border:1px dashed rgba(255,255,255,0.03);cursor:pointer}
  .uno-info{font-size:12px;color:var(--muted)}
  /* bigger bold turn label */
  .turn-label{font-size:14px;color:var(--muted)}
  .turn-value{font-weight:700;color:var(--text);font-size:15px;margin-left:6px}

  footer{margin-top:6px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap;gap:8px}

  /* responsive: multi-column layout for larger screens and fluid stacking for small ones */
  @media(min-width:980px){
    .wrap{max-width:1200px}
    .game-body{align-items:flex-start}
    main{padding:18px}
    .game-body > div:first-child{flex:1 1 520px}
    .game-body > div:last-child{flex:0 0 220px}
  }
  @media(max-width:980px){
    .t3{width:220px;height:220px}
    .simon-grid{grid-template-columns:repeat(2,96px)}
    .pad{width:96px;height:96px;font-size:14px}
    .board{grid-template-columns:repeat(10,20px);gap:3px}
    .card-ui{width:48px;height:68px;font-size:14px}
  }
  @media(max-width:520px){
    header{flex-wrap:wrap}
    .top-cta{width:100%;justify-content:flex-end}
    .t3{width:180px;height:180px}
    .simon-grid{grid-template-columns:repeat(2,84px)}
    .pad{width:84px;height:84px;font-size:13px}
    .board{grid-template-columns:repeat(10,18px);gap:3px}
    .card-ui{width:44px;height:64px;font-size:13px}
    .game-top{flex-direction:column;align-items:flex-start;gap:8px}
    .turn-value{font-size:14px}
  }
  /* accessibility focus */
  .btn:focus, .card-ui:focus, select:focus{outline:3px solid rgba(108,142,245,0.18);outline-offset:2px}
</style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo">CIIT</div>
        <div>
          <h1>CIIT Mind & Strategy Challenge</h1>
          <p class="lead">Short strategy mini‑games to sharpen planning, focus, and decision-making</p>
        </div>
      </div>

      <div class="top-cta" id="topCta">
        <div class="rounds-summary">Completed rounds: <strong id="roundCountHeader">0</strong></div>
        <div class="finish-cta">
          <button id="finishHeaderBtn" class="finish-btn" onclick="openForm(event)" disabled>Finish & Give Feedback</button>
        </div>
      </div>
    </header>

    <main>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 6px 0;color:var(--text);font-size:15px">Play Area</h2>
          <div style="color:var(--muted);font-size:12px">They can play anything. After 2 completed rounds the feedback form unlocks.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Rounds: <strong id="roundCount">0</strong></div>
        </div>
      </div>

      <div id="play-area">
        <!-- selector -->
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
          <div>
            <h3 style="margin-bottom:4px">Choose a game</h3>
            <div style="color:var(--muted);font-size:12px">Tactical mini-games, short rounds.</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" data-game="tic" onclick="selectGame('tic')">Tic Tac Toe</button>
            <button class="btn" data-game="simon" onclick="selectGame('simon')">Pattern Memory</button>
            <button class="btn" data-game="bship" onclick="selectGame('bship')">Battleship</button>
            <button class="btn" data-game="uno" onclick="selectGame('uno')">UNO</button>
          </div>
        </div>

        <!-- Tic Tac Toe -->
        <section id="tic" class="game-panel">
          <div class="game-top">
            <div class="game-title"><span class="dot t1"></span><div><strong style="font-size:14px">Tactical Tic Tac Toe</strong><div style="font-size:12px;color:var(--muted)">Beat the heuristic AI.</div></div></div>
            <div>
              <button class="btn small" onclick="resetTic()">Restart</button>
              <button class="btn small ghost" onclick="completeRound('TicTacToe')">Mark Complete</button>
            </div>
          </div>
          <div class="game-body">
            <div>
              <div class="t3" id="tgrid" aria-label="Tic tac toe grid"></div>
              <div class="tinfo" id="tmsg">Your turn — X</div>
            </div>
            <div style="min-width:160px">
              <div style="font-weight:700;margin-bottom:6px">How it works</div>
              <div style="color:var(--muted);font-size:12px">You are X. AI O blocks/wins heuristically. Finish or press Mark Complete.</div>
            </div>
          </div>
        </section>

        <!-- Simon -->
        <section id="simon" class="game-panel">
          <div class="game-top">
            <div class="game-title"><span class="dot t2"></span><div><strong style="font-size:14px">Pattern Memory (Simon)</strong><div style="font-size:12px;color:var(--muted)">Reach Level 5 to count as a win.</div></div></div>
            <div>
              <button class="btn small" id="sStart">Start</button>
              <button class="btn small ghost" onclick="completeRound('PatternMemory')">Mark Complete</button>
            </div>
          </div>
          <div class="game-body">
            <div>
              <div class="simon-grid" id="pads">
                <div class="pad red" data-color="red">Red</div>
                <div class="pad green" data-color="green">Green</div>
                <div class="pad blue" data-color="blue">Blue</div>
                <div class="pad yellow" data-color="yellow">Yellow</div>
              </div>
              <div style="margin-top:10px" class="tinfo">Level: <strong id="sLevel">0</strong> — Best: <strong id="sBest">0</strong></div>
            </div>
            <div style="min-width:160px">
              <div style="font-weight:700;margin-bottom:6px">Tip</div>
              <div style="color:var(--muted);font-size:12px">Watch then repeat. Level 5 counts as a strong practice result.</div>
            </div>
          </div>
        </section>

        <!-- Battleship -->
        <section id="bship" class="game-panel">
          <div class="game-top">
            <div class="game-title"><span class="dot t3"></span><div><strong style="font-size:14px">Battleship (Turn-based)</strong><div style="font-size:12px;color:var(--muted)">10×10 vs AI. Sink all ships.</div></div></div>
            <div>
              <button class="btn small" onclick="startBShip()">New Game</button>
              <button class="btn small ghost" onclick="completeRound('Battleship')">Mark Complete</button>
            </div>
          </div>
          <div class="game-body">
            <div class="board-wrap">
              <div>
                <div style="font-weight:700;margin-bottom:6px">Your View</div>
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px">
                  Ships: green; Bullets: blue; Hit: red; Sunk: black
                </div>
                <div class="board" id="playerBoard" aria-label="Your board"></div>
              </div>
              <div>
                <div style="font-weight:700;margin-bottom:6px">Enemy View (Click to Fire)</div>
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px">
                  Enemy hits: red; bullets: blue; sunk: black
                </div>
                <div class="board" id="enemyBoard" aria-label="Enemy board"></div>
              </div>
            </div>
            <div style="min-width:140px">
              <div class="status-line" id="bshipStatus">Press New Game to place ships and begin.</div>
              <div style="margin-top:8px" class="tinfo">Ships: Carrier(5), Battleship(4), Cruiser(3), Sub(3), Destroyer(2)</div>
            </div>
          </div>
        </section>

        <!-- UNO -->
        <section id="uno" class="game-panel">
          <div class="game-top">
            <div class="game-title"><span class="dot t4"></span><div><strong style="font-size:14px">UNO — Quick Match</strong><div style="font-size:12px;color:var(--muted)">S = Skip, R = Reverse. Drawing ends your turn.</div></div></div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label style="font-size:12px;color:var(--muted);margin-right:6px">AI players</label>
              <select id="unoAICount" aria-label="UNO AI count" style="background:#0b3b48;color:var(--text);border-radius:6px;padding:6px 8px;border:1px solid rgba(255,255,255,0.03);font-size:13px">
                <option value="1">1 AI</option>
                <option value="2" selected>2 AI</option>
                <option value="3">3 AI</option>
                <option value="4">4 AI</option>
                <option value="5">5 AI</option>
                <option value="6">6 AI</option>
                <option value="7">7 AI</option>
                <option value="8">8 AI</option>
                <option value="9">9 AI</option>
                <option value="10">10 AI</option>
              </select>
              <button class="btn small" onclick="startUno()">New Match</button>
              <button class="btn small ghost" onclick="completeRound('UNO')">Mark Complete</button>
            </div>
          </div>

          <div class="game-body" style="align-items:flex-start">
            <div style="flex:1;min-width:220px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <div style="font-weight:700">Table</div>
                <div class="turn-label">Turn:<span id="unoTurn" class="turn-value">—</span></div>
              </div>

              <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:8px">
                <div style="min-width:90px">
                  <div style="font-size:12px;color:var(--muted)">Deck</div>
                  <div class="uno-deck" id="deck" onclick="drawCardFromDeck(true)" title="Click to draw one card">Deck</div>
                </div>
                <div style="flex:1">
                  <div style="font-size:12px;color:var(--muted)">Discard</div>
                  <div id="discard" style="min-height:56px;display:flex;align-items:center;justify-content:center"></div>
                </div>
              </div>

              <div style="margin-top:6px">
                <div style="font-weight:700">Your Hand</div>
                <div id="playerHand" class="hand two-rows" aria-live="polite"></div>
                <div style="margin-top:6px" class="uno-info">AI Hands — <span id="aiLabels">AI A: <strong id="aiAcount">0</strong></span></div>
              </div>
            </div>

            <div style="min-width:220px">
              <div style="font-weight:700;margin-bottom:6px">UNO rules (brief)</div>
              <div style="color:var(--muted);font-size:12px;line-height:1.35">
                Match color or number. Action cards:
                <ul style="margin:6px 0 0 18px;color:var(--muted)">
                  <li><strong>S</strong> Skip the next player</li>
                  <li><strong>R</strong> Reverse play direction</li>
                </ul>
                Drawing from deck ends your turn. You can pick 1 to 10 AI before starting UNO. AI behavior: plays first playable card or draws.
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>

    <footer>
      <div style="display:flex;gap:10px;align-items:center"><div style="font-weight:700">CIIT Mind & Strategy</div><div style="color:var(--muted);font-size:12px">Play, Learn, Compete</div></div>
      <div style="color:var(--muted);font-size:12px">Completed rounds: <strong id="footCount">0</strong></div>
    </footer>
  </div>

<script>
/* ========= Shared progress tracking ========= */
let roundsCompleted = 0;
const GOOGLE_FORM = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';

function updateRoundUI(){
  document.getElementById('roundCount').textContent = roundsCompleted;
  document.getElementById('roundCountHeader').textContent = roundsCompleted;
  document.getElementById('footCount').textContent = roundsCompleted;
}
function incRound(){
  roundsCompleted++;
  updateRoundUI();
  if(roundsCompleted >= 2) enableFinish();
}
function completeRound(name){
  incRound();
  alert('Marked as complete: ' + name + '. Rounds counted: ' + roundsCompleted);
}
function enableFinish(){
  const fb = document.getElementById('finishHeaderBtn');
  fb.removeAttribute('disabled');
}
function openForm(e){
  if(e) e.preventDefault();
  if(roundsCompleted < 2){ alert('Please complete at least 2 rounds across games to proceed to the feedback form.'); return; }
  window.open(GOOGLE_FORM, '_blank');
}

/* ===== game selector ===== */
function selectGame(id){
  document.querySelectorAll('.game-panel').forEach(g=>g.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ========= Tic Tac Toe ========= */
const tgrid = document.getElementById('tgrid');
let tstate = Array(9).fill(null);
let tgameOver = false;
function renderTic(){ tgrid.innerHTML=''; tstate.forEach((v,i)=>{ const d=document.createElement('div'); d.className='cell'+(v?' locked':''); d.innerHTML = v? v : ''; d.onclick=()=>{ if(!tstate[i] && !tgameOver) playTic(i) }; tgrid.appendChild(d); }); }
function resetTic(){ tstate=Array(9).fill(null); tgameOver=false; document.getElementById('tmsg').textContent='Your turn — X'; renderTic(); }
function playTic(i){ if(tgameOver||tstate[i]) return; tstate[i]='X'; renderTic(); if(checkWin(tstate,'X')){ endTic('You win!'); return; } if(tstate.every(Boolean)){ endTic('Draw'); return; } document.getElementById('tmsg').textContent='AI thinking…'; setTimeout(aiMoveTic,300); }
function aiMoveTic(){ const o='O'; const idx = findWinning(tstate,o) ?? findWinning(tstate,'X') ?? (tstate[4]? null:4) ?? getCorner() ?? getRandom(); if(idx!=null) tstate[idx]=o; renderTic(); if(checkWin(tstate,'O')){ endTic('AI wins'); return; } if(tstate.every(Boolean)){ endTic('Draw'); return; } document.getElementById('tmsg').textContent='Your turn — X'; }
function checkWin(s,p){ const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; return wins.some(w=>w.every(i=>s[i]===p)); }
function findWinning(s,player){ for(let i=0;i<9;i++){ if(!s[i]){ s[i]=player; const ok=checkWin(s,player); s[i]=null; if(ok) return i; } } return null; }
function getCorner(){ const corners=[0,2,6,8].filter(i=>!tstate[i]); return corners.length ? corners[Math.floor(Math.random()*corners.length)] : null; }
function getRandom(){ const empt = tstate.map((v,i)=>v?null:i).filter(v=>v!==null); return empt.length? empt[Math.floor(Math.random()*empt.length)] : null; }
function endTic(msg){ tgameOver=true; document.getElementById('tmsg').textContent = msg; incRound(); }
resetTic();

/* ========= Simon ========= */
const padEls = Array.from(document.querySelectorAll('.pad'));
let simonSeq = [], simonInput = [], simonLevel = 0, simonBusy = false, sBest = 0;
function sStart(){ simonSeq=[]; simonLevel=0; sNext(); }
function sNext(){ simonLevel++; document.getElementById('sLevel').textContent = simonLevel; if(simonLevel> sBest){ sBest=simonLevel; document.getElementById('sBest').textContent=sBest; } const colorsArr=['red','green','blue','yellow']; simonSeq.push(colorsArr[Math.floor(Math.random()*colorsArr.length)]); playSequence(); }
function playSequence(){ simonBusy=true; simonInput=[]; let i=0; const tick=()=>{ if(i>=simonSeq.length){ simonBusy=false; return; } flashPad(simonSeq[i]); i++; setTimeout(tick,520); }; tick(); }
function flashPad(color){ const el = padEls.find(p=>p.dataset.color===color); if(!el) return; el.style.filter='brightness(1.3)'; setTimeout(()=>el.style.filter='',300); }
padEls.forEach(p=>{ p.addEventListener('click', ()=>{ if(simonBusy) return; const col=p.dataset.color; simonInput.push(col); flashPad(col); const idx=simonInput.length-1; if(simonInput[idx]!==simonSeq[idx]){ alert('Wrong pattern — try again from start of level'); simonInput=[]; playSequence(); return; } if(simonInput.length===simonSeq.length){ if(simonLevel>=5){ alert('Great — you reached level ' + simonLevel + '!'); incRound(); } setTimeout(sNext,400); } }); });
document.getElementById('sStart').addEventListener('click', sStart);

/* ========= Battleship ========= */
const pBoard = document.getElementById('playerBoard');
const eBoard = document.getElementById('enemyBoard');
const bStatus = document.getElementById('bshipStatus');
const BSZ = 10;
let playerGrid = [], enemyGrid = [], enemyShips = [], playerShips = [], bTurn = 'player';
let bGameOver = false; // new flag to stop actions after game ends
let bRoundAwarded = false; // ensure incRound executed only once per game win

function startBShip(){
  playerGrid = Array(BSZ).fill(0).map(()=>Array(BSZ).fill(0));
  enemyGrid = Array(BSZ).fill(0).map(()=>Array(BSZ).fill(0));
  playerShips = placeRandomShips(playerGrid);
  enemyShips = placeRandomShips(enemyGrid);
  renderBoards();
  bStatus.textContent = 'Game ready. Click on the enemy grid to fire.';
  bTurn = 'player';
  bGameOver = false;
  bRoundAwarded = false;
}
function placeRandomShips(grid){
  const ships = [{id:'C',len:5},{id:'B',len:4},{id:'R',len:3},{id:'S',len:3},{id:'D',len:2}];
  const placed = [];
  for(const s of ships){
    let tries=0;
    while(tries<200){
      tries++;
      const dir = Math.random()<0.5?'h':'v';
      const r = Math.floor(Math.random()*BSZ);
      const c = Math.floor(Math.random()*BSZ);
      if(dir==='h' && c + s.len <= BSZ){
        let ok=true; for(let k=0;k<s.len;k++) if(grid[r][c+k]!==0) ok=false;
        if(!ok) continue;
        const cells=[];
        for(let k=0;k<s.len;k++){ grid[r][c+k]=s.id; cells.push([r,c+k]); }
        placed.push({id:s.id,cells:new Set(cells.map(a=>a.join(','))),len:s.len,hits:0});
        break;
      } else if(dir==='v' && r + s.len <= BSZ){
        let ok=true; for(let k=0;k<s.len;k++) if(grid[r+k][c]!==0) ok=false;
        if(!ok) continue;
        const cells=[];
        for(let k=0;k<s.len;k++){ grid[r+k][c]=s.id; cells.push([r+k,c]); }
        placed.push({id:s.id,cells:new Set(cells.map(a=>a.join(','))),len:s.len,hits:0});
        break;
      }
    }
  }
  return placed;
}
function renderBoards(){
  pBoard.innerHTML=''; eBoard.innerHTML='';
  const playerSunkIds = new Set(playerShips.filter(s=>s.hits>=s.len).map(s=>s.id));
  const enemySunkIds = new Set(enemyShips.filter(s=>s.hits>=s.len).map(s=>s.id));
  for(let r=0;r<BSZ;r++){
    for(let c=0;c<BSZ;c++){
      const pcell = document.createElement('div'); pcell.className='cell-b';
      if(playerGrid[r][c] === 'H'){ pcell.classList.add('hit'); pcell.textContent='✖'; }
      else if(playerGrid[r][c] === 'M'){ pcell.classList.add('miss'); pcell.textContent='·'; }
      else if(playerGrid[r][c] && playerGrid[r][c] !== 0){
        const id = playerGrid[r][c]; const sunk = playerSunkIds.has(id);
        if(sunk){ pcell.classList.add('sunk'); }
        else { const sEl=document.createElement('div'); sEl.className='ship-vis'; pcell.appendChild(sEl); }
      }
      pBoard.appendChild(pcell);

      const ecell = document.createElement('div'); ecell.className='cell-b'; ecell.dataset.r=r; ecell.dataset.c=c;
      ecell.onclick = ()=>fireAt(r,c,ecell);
      const val = enemyGrid[r][c];
      if(val === 'M'){ ecell.classList.add('bullet'); ecell.textContent='·'; }
      if(val === 'H'){
        let hitShipId = null;
        for(const s of enemyShips) if(s.cells.has([r,c].join(','))) { hitShipId = s.id; break; }
        const sunk = hitShipId ? enemySunkIds.has(hitShipId) : false;
        if(sunk) { ecell.classList.add('sunk'); ecell.textContent='✖'; }
        else { ecell.classList.add('hit'); ecell.textContent='✖'; }
      }
      eBoard.appendChild(ecell);
    }
  }
}
function fireAt(r,c){
  // block clicks if game over
  if(bGameOver){ bStatus.textContent = 'Game over. Start a new game.'; return; }

  if(bTurn!=='player'){ bStatus.textContent='Not your turn.'; return; }
  if(enemyGrid[r][c] === 'M' || enemyGrid[r][c] === 'H'){ bStatus.textContent='You already fired here.'; return; }
  let hit=false;
  for(const s of enemyShips){
    if(s.cells.has([r,c].join(','))){ hit=true; s.hits++; enemyGrid[r][c]='H'; bStatus.textContent='Hit!'; if(s.hits>=s.len) bStatus.textContent=`You sank enemy ${s.id}!`; break; }
  }
  if(!hit){ enemyGrid[r][c]='M'; bStatus.textContent='Miss. Enemy turn.'; }
  renderBoards();

  // check win condition and handle exactly once
  if(enemyShips.every(s=>s.hits>=s.len)){
    bStatus.textContent='You win — all enemy ships sunk!';
    if(!bRoundAwarded){
      bRoundAwarded = true;
      incRound();
    }
    bGameOver = true;
    // small user-visible notification in addition to bStatus
    setTimeout(()=>{ alert('Victory — you sank all enemy ships!'); }, 50);
    return;
  }

  bTurn='enemy';
  setTimeout(enemyShot,500);
}
function enemyShot(){
  if(bGameOver) return;
  let r,c;
  do { r=Math.floor(Math.random()*BSZ); c=Math.floor(Math.random()*BSZ); } while(playerGrid[r][c]==='M' || playerGrid[r][c]==='H');
  if(playerGrid[r][c] !== 0 && playerGrid[r][c] !== 'M' && playerGrid[r][c] !== 'H'){
    const id = playerGrid[r][c]; playerGrid[r][c] = 'H';
    for(const s of playerShips) if(s.id===id && s.cells.has([r,c].join(','))){ s.hits++; bStatus.textContent='Enemy hit your ship!'; if(s.hits>=s.len) bStatus.textContent='Enemy sank your ship: ' + s.id; break; }
  } else { playerGrid[r][c] = 'M'; bStatus.textContent='Enemy missed. Your turn.'; }
  renderBoards();

  // check enemy win
  if(playerShips.every(s=>s.hits>=s.len)){
    bStatus.textContent='Enemy wins. Your ships sunk.';
    bGameOver = true;
    setTimeout(()=>{ alert('Defeat — all your ships were sunk.'); }, 50);
    return;
  }

  bTurn='player';
}

/* ========= UNO (1-10 AI supported) ========= */
let unoDeck = [], unoDiscard = [], playerHand = [], aiHands = [], unoPlayerIndex = 0, unoTop = null, playDirection = 1;

function buildDeck(){
  const d=[]; const colors=['red','green','blue','yellow'];
  for(const col of colors){
    d.push({color:col,val:'0'});
    for(let rep=0;rep<2;rep++){
      for(let n=1;n<=9;n++) d.push({color:col,val:String(n)});
      d.push({color:col,val:'S'}); d.push({color:col,val:'R'});
    }
  }
  for(let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}

function startUno(){
  const aiCount = Math.max(1, Math.min(10, Number(document.getElementById('unoAICount').value) || 2));
  unoDeck = buildDeck(); unoDiscard=[]; playerHand=[]; aiHands = Array.from({length:aiCount},()=>[]);
  // deal 7 to each (player then each ai in round robin)
  for(let i=0;i<7;i++){
    playerHand.push(unoDeck.pop());
    for(let a=0;a<aiCount;a++) aiHands[a].push(unoDeck.pop());
  }
  // initial discard
  unoTop = unoDeck.pop(); unoDiscard.push(unoTop);
  unoPlayerIndex = 0; playDirection = 1;
  renderUno();
  writeUnoTurn();
  updateAiLabels();
}

function renderUno(){
  const handEl = document.getElementById('playerHand');
  handEl.innerHTML = '';
  playerHand.forEach((c,idx)=>{
    const el = document.createElement('div'); el.className='card-ui uno-'+c.color; el.textContent=c.val; el.title=c.color+' '+c.val; el.onclick=()=>playerPlayCard(idx); el.tabIndex=0; handEl.appendChild(el);
  });
  const disc = document.getElementById('discard'); disc.innerHTML='';
  if(unoTop){ const el=document.createElement('div'); el.className='card-ui uno-'+unoTop.color; el.textContent=unoTop.val; disc.appendChild(el); }
  updateAiCountsInUI();
  document.getElementById('unoTurn').textContent = getPlayerLabel(unoPlayerIndex);
}

function updateAiLabels(){
  // render ai labels (AI 1: n | AI 2: n | ...)
  const wrap = document.getElementById('aiLabels');
  const parts = [];
  for(let i=0;i<aiHands.length;i++){
    parts.push(`AI ${i+1}: <strong id="ai${i}count">${aiHands[i].length}</strong>`);
  }
  wrap.innerHTML = parts.join(' | ');
}

function updateAiCountsInUI(){
  for(let i=0;i<aiHands.length;i++){
    const el = document.getElementById(`ai${i}count`);
    if(el) el.textContent = aiHands[i].length;
  }
}

function getPlayerLabel(index){
  if(index === 0) return 'You';
  return `AI ${index}`;
}

function canPlay(card, top){ return card.color === top.color || card.val === top.val; }

function playerPlayCard(idx){
  if(unoPlayerIndex !== 0) return alert('Not your turn yet');
  const card = playerHand[idx];
  if(!canPlay(card, unoTop)) return alert('Cannot play that card. Draw 1 or play matching color/number.');
  playerHand.splice(idx,1); unoDiscard.push(card); unoTop = card;
  if(card.val === 'S'){ advanceTurn(true); } 
  else if(card.val === 'R'){ playDirection *= -1; advanceTurn(false); }
  else { advanceTurn(false); }
  renderUno(); checkUnoWinner();
}

function drawCardFromDeck(userClicked=false){
  if(unoDeck.length === 0){ reshuffleDiscard(); }
  const drawn = unoDeck.pop();
  if(userClicked){
    playerHand.push(drawn); renderUno();
    setTimeout(()=>{ advanceTurn(false); }, 150);
    return;
  } else return drawn;
}

function reshuffleDiscard(){ if(unoDiscard.length<=1) return; const top = unoDiscard.pop(); unoDeck = unoDiscard.sort(()=>Math.random()-0.5); unoDiscard=[top]; }

function modIndex(i, total){ return ((i % total) + total) % total; }

function advanceTurn(skipNext){
  const totalPlayers = 1 + aiHands.length;
  if(skipNext){
    unoPlayerIndex = modIndex(unoPlayerIndex + playDirection + playDirection, totalPlayers);
  } else {
    unoPlayerIndex = modIndex(unoPlayerIndex + playDirection, totalPlayers);
  }
  renderUno();
  if(unoPlayerIndex === 0) { writeUnoTurn(); return; }
  setTimeout(aiPlayIfNeeded, 300);
}

function aiPlayIfNeeded(){
  const aiIndex = unoPlayerIndex - 1; // aiHands index
  if(aiIndex < 0 || aiIndex >= aiHands.length){ renderUno(); return; }
  const hand = aiHands[aiIndex];
  const playIdx = hand.findIndex(c=>canPlay(c, unoTop));
  if(playIdx >= 0){
    const card = hand.splice(playIdx,1)[0]; unoDiscard.push(card); unoTop = card;
    if(card.val === 'S'){ advanceTurn(true); renderUno(); checkUnoWinner(); return; }
    if(card.val === 'R'){ playDirection *= -1; advanceTurn(false); renderUno(); checkUnoWinner(); return; }
    advanceTurn(false); renderUno(); checkUnoWinner(); return;
  } else {
    if(unoDeck.length === 0) reshuffleDiscard();
    const d = unoDeck.pop(); hand.push(d);
    setTimeout(()=>{ advanceTurn(false); renderUno(); }, 200);
  }
}

function checkUnoWinner(){
  if(playerHand.length === 0){ alert('You won UNO!'); incRound(); startUno(); return; }
  for(let i=0;i<aiHands.length;i++) if(aiHands[i].length === 0){ alert('AI won — match over.'); startUno(); return; }
}

function writeUnoTurn(){ document.getElementById('unoTurn').textContent = getPlayerLabel(unoPlayerIndex); }

/* initialize */
selectGame('tic');
document.getElementById('deck').addEventListener('click', ()=>drawCardFromDeck(true));
document.getElementById('sStart').addEventListener('click', sStart);

/* small protections */
window.addEventListener('beforeunload', function(e){ if(roundsCompleted>0){ e.preventDefault(); e.returnValue=''; } });
</script>
</body>
</html>
